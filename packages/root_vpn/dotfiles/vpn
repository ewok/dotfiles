#!/usr/bin/env bash

# set -x

NAME="$1"
if [[ -z "$NAME" ]];then echo "Please specify vpn name!"; exit 1;fi

# if [ ! $(command -v rofi_run) ];then echo "Install rofi"; exit 1;fi
if [ ! $(command -v ykman) ];then YKMAN=1; else YKMAN=0;fi
if [ ! $(command -v setfattr) ];then SE=1; else SE=0;fi

#  Init sudo
prompt=$(sudo -nv 2>&1)
if [ $? -eq 0 ]; then
echo "Sudo priveleges available."
elif echo $prompt | grep -q '^sudo:'; then
# echo "$(rofi_run -password -dmenu -p 'Sudo password' -l 0 -sidebar -width 20)" | sudo -S echo "Granted"
sudo echo ""
else
rofi -dmenu -mesg "You don't have sudo priveleges." -a "vpn"
exit 2
fi

export DBUS_SESSION_BUS_ADDRESS=/dev/null

set -e

cleanup()
{
sudo rm -f ~/share/vpn/*.pw
}
trap 'cleanup' 1 2 3 6 15

get()
{
prop_name=$1
echo "$(bash ~/share/vpn/$NAME.conf | grep "$prop_name" | cut -f2 -d=)"
}

PASSWORD_TOOL=$(get PwdTool)
PASSWORD_ENTITY=$(get PwdEntity)
OTP_ENTITY=$(get OtpEntity)

sudo systemctl stop vpn@$1.service

if [[ "$2" == "stop" ]];then exit 0;fi

if [[ -n "$PASSWORD_TOOL" ]]
then
    sudo rm -f ~/share/vpn/$NAME.pw

    set -e
    case "$PASSWORD_TOOL" in
      lpass)
        lpass show $PASSWORD_ENTITY --username > ~/share/vpn/$NAME.pw
        lpass show $PASSWORD_ENTITY --password >> ~/share/vpn/$NAME.pw
      ;;
      op)
        op-session item get $PASSWORD_ENTITY --fields username > ~/share/vpn/$NAME.pw
        op-session item get $PASSWORD_ENTITY --fields password >> ~/share/vpn/$NAME.pw
      ;;
      *)
        echo "Unsupported PW tool $PASSWORD_TOOL"
        exit 2
      ;;
    esac

    sudo chmod 0600 ~/share/vpn/$NAME.pw
    #sudo chown openvpn ~/share/vpn/$NAME.pw
    if [[ $SE -eq 0 ]]; then
        sudo setfattr -n security.selinux -v "system_u:object_r:etc_t:s0" ~/share/vpn/$NAME.pw
    fi

    if [[ $YKMAN -eq 0 ]]; then
        if [[ -n "$OTP_ENTITY" ]]; then
          set +e
          ykman oath accounts code openvpn_$NAME | awk '{print $2}' | xclip -i -f -selection primary | xclip -i -selection clipboard
          set -e
        fi
    fi

    else
    echo "nobody" > ~/share/vpn/$NAME.pw
    echo "nopassword" >> ~/share/vpn/$NAME.pw

    if [[ $SE -eq 0 ]]; then
        sudo setfattr -n security.selinux -v "system_u:object_r:etc_t:s0" ~/share/vpn/$NAME.pw
    fi
fi

if [[ $SE -eq 0 ]]; then
    sudo setfattr -n security.selinux -v "system_u:object_r:etc_t:s0" ~/share/vpn/$NAME.ovpn
fi
sudo systemctl start vpn@$1.service

set +e
notify-send -t 5000 "VPN $NAME complete"
cleanup

journalctl -f -u vpn@$NAME
